<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Payments_Sample Analisyng</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="papaparse.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="hideable">
            <h1 name="Titulo" align="center" style="margin-top: 200px;">Payments_Sample Analisyng - Melhor Fornecedor do
                Mês</h1>
            <br>

            <div align="center" id="receptor">
                <h3>Selecione o Arquivo CSV</h3>
                <input name="Arquivo CSV" type="file" id="inputfile" />
                <br><br>
                <input type="button" class="btn btn-info" id="converter" value="Converter" />
            </div>
            <br><br>

            <div align="center" id="options">
                <div align="center">
                    <a href="#" id="salvar_html" onClick="save()" class="btn btn-info"> Salvar HTML </a>
                </div><br>
            </div>
        </div>

        <div class="table-responsive" id="response">
            <table id="tabela_dados" class="table table-striped table-bordered">
            </table>
        </div>
    </div>

    <br><br>
    <h6 align="center">Developed by Maurício Cavalcante</h6>
</body>

</html>

<script>
    //Salvar a pagina Html
    function save() {
        $('#hideable').hide();
        $('#cabecalho').show();
        var content = document.documentElement.innerHTML;
        download(content, "index", "html");
        $('#hideable').show();
    }
    function download(content, fileName, fileType) {
        var link = document.getElementById("salvar_html");
        var file = new Blob([content], { type: fileType });
        var donwloadFile = fileName + "." + fileType;
        link.href = URL.createObjectURL(file);
        link.download = donwloadFile
    }

    //Ordenar CSV de acordo com o Valor (3ª casa da Array)
    function compareValores(a, b) {
        var aArr = a.split(',');
        var bArr = b.split(',');
        return bArr[3] - aArr[3];
    }

</script>



<script>
    $(document).ready(function () {
        $('#options').hide();
        $('#converter').bind("click", function () {
            $('#options').show();
            //Recebe o Arquivo Selecionado
            var reader = new FileReader();
            reader.onload = function (e) {
                var table_data = "<tr>   <th>Mês</th>   <th>Fornecedor</th>   <th>Valor</th>   </tr>";
                var file = e.target.result;

                //Cria array das linhas
                var parsedCSV = Papa.parse(file, { header: true });
                var dados = parsedCSV.data;

                //Cria meses
                var meses = [];
                for (var countMonth = 0; countMonth < dados.length - 1; countMonth++) {
                    var possibleNewMonth = dados[countMonth].data.substring(0, 7);
                    if (meses.indexOf(possibleNewMonth) == -1) {
                        meses.push(possibleNewMonth);
                    }
                }


                //Escolhe o melhor fornecedor
                for (var i = 0; i < meses.length; i++) {
                    let indexMaxValue = 0;
                    let maxValue = 0;
                    for (var j = 0; j < dados.length - 1; j++) {
                        var thisData = dados[j].data.substring(0, 7);
                        if (thisData == meses[i]) {
                            if (Number(dados[j].valor) >= Number(maxValue)) {
                                maxValue = dados[j].valor;
                                indexMaxValue = j;
                                console.log(maxValue);
                            }
                        }
                    }
                    table_data += '<tr>';
                    table_data += '<td>' + meses[i] + '</td>';
                    table_data += '<td>' + dados[indexMaxValue].fornecedor + '</td>';
                    table_data += '<td>' + dados[indexMaxValue].valor + '</td>';
                    table_data += "</tr>";
                }
                $("#tabela_dados").append(table_data);
            }
            reader.readAsText($("#inputfile")[0].files[0]);
        });
    });
</script>